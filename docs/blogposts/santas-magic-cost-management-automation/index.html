<!DOCTYPE html>
<html class="no-js" lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Santa´s Magic Cost Management Automation - Erlend Rushfeldt - Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="//localhost:1313/blogposts/santas-magic-cost-management-automation/">
  <meta property="og:site_name" content="Erlend Rushfeldt - Blog">
  <meta property="og:title" content="Santa´s Magic Cost Management Automation">
  <meta property="og:description" content="This blogpost is posted in correlation with the Festive Tech Calendar. Festive Tech Calendar is a community event that goes on through the whole of December. The event is raising donations for the Raspberry PI Foundation. The Raspberry PI Foundation is a charity that help children learn to code. Please checkout the Just Giving page and the Festive Tech Calendar.
Santa’s workshop has changed immensely the last 10 years. With kids wanting iPhones, PlayStations or the newest Fortnite battle pass. To adopt to this, half of the elves now work as developers from home, writing code for new cool games and digital toys. In the year 2023, AI is on the rise and Santa wants to capitalize on the hype and produce new cool toys using AI. To innovate new toys, the elves has gotten their own Azure Sandbox subscriptions to play around with the new services.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blogposts">
    <meta property="article:published_time" content="2023-12-05T00:00:00+01:00">
    <meta property="article:modified_time" content="2023-12-05T00:00:00+01:00">
    <meta property="article:tag" content="Cost Management">
    <meta property="article:tag" content="Festive Tech Calendar">
    <meta property="article:tag" content="Automation">
    <meta property="article:tag" content="Governance">

		
  <meta itemprop="name" content="Santa´s Magic Cost Management Automation">
  <meta itemprop="description" content="This blogpost is posted in correlation with the Festive Tech Calendar. Festive Tech Calendar is a community event that goes on through the whole of December. The event is raising donations for the Raspberry PI Foundation. The Raspberry PI Foundation is a charity that help children learn to code. Please checkout the Just Giving page and the Festive Tech Calendar.
Santa’s workshop has changed immensely the last 10 years. With kids wanting iPhones, PlayStations or the newest Fortnite battle pass. To adopt to this, half of the elves now work as developers from home, writing code for new cool games and digital toys. In the year 2023, AI is on the rise and Santa wants to capitalize on the hype and produce new cool toys using AI. To innovate new toys, the elves has gotten their own Azure Sandbox subscriptions to play around with the new services.">
  <meta itemprop="datePublished" content="2023-12-05T00:00:00+01:00">
  <meta itemprop="dateModified" content="2023-12-05T00:00:00+01:00">
  <meta itemprop="wordCount" content="1369">
  <meta itemprop="keywords" content="Cost Management,Festive Tech Calendar,Automation,Governance">
		
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Santa´s Magic Cost Management Automation">
  <meta name="twitter:description" content="This blogpost is posted in correlation with the Festive Tech Calendar. Festive Tech Calendar is a community event that goes on through the whole of December. The event is raising donations for the Raspberry PI Foundation. The Raspberry PI Foundation is a charity that help children learn to code. Please checkout the Just Giving page and the Festive Tech Calendar.
Santa’s workshop has changed immensely the last 10 years. With kids wanting iPhones, PlayStations or the newest Fortnite battle pass. To adopt to this, half of the elves now work as developers from home, writing code for new cool games and digital toys. In the year 2023, AI is on the rise and Santa wants to capitalize on the hype and produce new cool toys using AI. To innovate new toys, the elves has gotten their own Azure Sandbox subscriptions to play around with the new services.">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="Erlend Rushfeldt - Blog" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">Erlend Rushfeldt - Blog</div>
					
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About me</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Santa´s Magic Cost Management Automation</h1>
			<p class="post__lead">My contribution for Festive Tech Calendar 2023</p>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 1 1 0 28 1 1 0 0 1 0-28m0 3a3 3 0 1 0 0 22 3 3 0 0 0 0-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class="meta__text" datetime="2023-12-05T00:00:00&#43;01:00">05-12-2023</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/azure/" rel="category">Azure</a>
	</span>
</div></div>
		</header>
		
	<figure class="post__thumbnail thumbnail">
		
		<img class="thumbnail__image" src="/img/festive-thumbnail23.png" alt="Santa´s Magic Cost Management Automation">
		
	</figure><div class="content post__content clearfix">
			<p>This blogpost is posted in correlation with the Festive Tech Calendar. Festive Tech Calendar is a community event that goes on through the whole of December. The event is raising donations for the Raspberry PI Foundation. The Raspberry PI Foundation is a charity that help children learn to code. Please checkout the <a href="https://www.justgiving.com/page/festive-tech-calendar-2023">Just Giving page</a> and the <a href="https://festivetechcalendar.com/">Festive Tech Calendar</a>.</p>
<p>Santa&rsquo;s workshop has changed immensely the last 10 years. With kids wanting iPhones, PlayStations or the newest Fortnite battle pass. To adopt to this, half of the elves now work as developers from home, writing code for new cool games and digital toys. In the year 2023, AI is on the rise and Santa wants to capitalize on the hype and produce new cool toys using AI. To innovate new toys, the elves has gotten their own Azure Sandbox subscriptions to play around with the new services.</p>
<p>After 1 month, Santa realised that these AI services were a lot more expensive than he had anticipated. With the economy in recession, Santa needs to be careful with not overspending on development. To prevent the elves from using more than their projects allocated budget, Santa use Azure Cost Management to call automation for cleaning up the sandboxes.</p>
<p>So Santa&rsquo;s solution is divided into 2 parts. He has created a budget and an action group that calls an Automation Account that runs a PowerShell script that deletes all resources in the sandbox subscription.</p>
<p><strong>Important</strong> This demo of a PowerShell script will delete resources! Be very careful if you want to run it in your own environment. Please be sure that you understand and limit the damage it may cause.</p>
<p>This demo would require 2 different Azure subscriptions. 1 subscription that hosts the Automation Account and 1 subscription that will have all it&rsquo;s content deleted. A subscription in it self is free and therefore you shouldn&rsquo;t be afraid that cost will increase just because you need 2.</p>
<h2 id="the-automation-account">The Automation Account</h2>
<p>Let&rsquo;s start by looking at the Automation Account and the PowerShell script.
The Automation Account is placed in a seperate Azure subscription. A management subscription if you like. The Automation Account uses a system-assigned managed identity that has the role Contributor on the sandbox subscription. The Runbbok for the script is using PowerShell 7.1 and I have created a webhook so that we can call it from a action group. But don&rsquo;t think about that, you can set the webhook up when you configure the action group for the budget.</p>
<p>The PowerShell script it self is using a logic that I found in a cleanup script in the Azure Bicep CARML GitHub repo. The script is what Microsoft uses in CARML to cleanup resources that are deployed during moudle validation. The script is simple enough, it collects all resources and loops through all of them. It looks through what type the resource is and uses a switch to do special delete actions if they are needed. The default action of the switch is to just delete the resource. This script will only work with a single subscription. If you want to use it for potentially cleanup of several subscriptions based on which has a breached budget, you can use parameters and activate the common alert schema that can feed the info about which subscription has exceeded it&rsquo;s budget.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span><span style="color:#75715e">## set variables</span>
</span></span><span style="display:flex;"><span>$resources = @()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Auth</span>
</span></span><span style="display:flex;"><span>Connect-AzAccount -Identity
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Delete resources</span>
</span></span><span style="display:flex;"><span>$resources = get-azresources
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($resource <span style="color:#66d9ef">in</span> $resources) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $type = $resource.type
</span></span><span style="display:flex;"><span>    $ResourceId = $resource.Id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ($type) {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.Insights/diagnosticSettings&#39;</span> {
</span></span><span style="display:flex;"><span>            $parentResourceId = $ResourceId.Split(<span style="color:#e6db74">&#39;/providers/{0}&#39;</span> <span style="color:#f92672">-f</span> $Type)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>            $resourceName = Split-Path $ResourceId -Leaf
</span></span><span style="display:flex;"><span>            Remove-AzDiagnosticSetting -ResourceId $parentResourceId -Name $resourceName
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.Authorization/locks&#39;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">## Skipping locks</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.Consumption/budgets&#39;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">## Not deleting budgets</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.Insights/actionGroups&#39;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">## Not deleting Action Group used by budget automation</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.KeyVault/vaults/keys&#39;</span> {
</span></span><span style="display:flex;"><span>            $resourceName = Split-Path $ResourceId -Leaf
</span></span><span style="display:flex;"><span>            Write-Verbose (<span style="color:#e6db74">&#39;[/] Skipping resource [{0}] of type [{1}]. Reason: It is handled by different logic.&#39;</span> <span style="color:#f92672">-f</span> $resourceName, $Type) -Verbose
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Also, we don&#39;t want to accidently remove keys of the dependency key vault</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.KeyVault/vaults/accessPolicies&#39;</span> {
</span></span><span style="display:flex;"><span>            $resourceName = Split-Path $ResourceId -Leaf
</span></span><span style="display:flex;"><span>            Write-Verbose (<span style="color:#e6db74">&#39;[/] Skipping resource [{0}] of type [{1}]. Reason: It is handled by different logic.&#39;</span> <span style="color:#f92672">-f</span> $resourceName, $Type) -Verbose
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.ServiceBus/namespaces/authorizationRules&#39;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ((Split-Path $ResourceId <span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#ae81ff">-1</span>] <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#39;RootManageSharedAccessKey&#39;</span>) {
</span></span><span style="display:flex;"><span>                Write-Verbose (<span style="color:#e6db74">&#39;[/] Skipping resource [RootManageSharedAccessKey] of type [{0}]. Reason: The Service Bus&#39;&#39;s default authorization key cannot be removed&#39;</span> <span style="color:#f92672">-f</span> $Type) -Verbose
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                Remove-AzResource -ResourceId $ResourceId -Force -ErrorAction <span style="color:#e6db74">&#39;Stop&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.Compute/diskEncryptionSets&#39;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Pre-Removal</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># -----------</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Remove access policies on key vault</span>
</span></span><span style="display:flex;"><span>            $resourceGroupName = $ResourceId.Split(<span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>            $resourceName = Split-Path $ResourceId -Leaf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            $diskEncryptionSet = Get-AzDiskEncryptionSet -Name $resourceName -ResourceGroupName $resourceGroupName
</span></span><span style="display:flex;"><span>            $keyVaultResourceId = $diskEncryptionSet.ActiveKey.SourceVault.Id
</span></span><span style="display:flex;"><span>            $keyVaultName = Split-Path $keyVaultResourceId -Leaf
</span></span><span style="display:flex;"><span>            $objectId = $diskEncryptionSet.Identity.PrincipalId
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            Remove-AzKeyVaultAccessPolicy -VaultName $keyVaultName -ObjectId $objectId
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Actual removal</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># --------------</span>
</span></span><span style="display:flex;"><span>            Remove-AzResource -ResourceId $ResourceId -Force -ErrorAction <span style="color:#e6db74">&#39;Stop&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.RecoveryServices/vaults/backupstorageconfig&#39;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Not a &#39;resource&#39; that can be removed, but represents settings on the RSV. The config is deleted with the RSV</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.Authorization/roleAssignments&#39;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">## Don&#39;t want to remove roleAssignments</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.RecoveryServices/vaults&#39;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Pre-Removal</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># -----------</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Remove protected VMs</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ((Get-AzRecoveryServicesVaultProperty -VaultId $ResourceId).SoftDeleteFeatureState <span style="color:#f92672">-ne</span> <span style="color:#e6db74">&#39;Disabled&#39;</span>) {
</span></span><span style="display:flex;"><span>                Set-AzRecoveryServicesVaultProperty -VaultId $ResourceId -SoftDeleteFeatureState <span style="color:#e6db74">&#39;Disable&#39;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            $backupItems = Get-AzRecoveryServicesBackupItem -BackupManagementType <span style="color:#e6db74">&#39;AzureVM&#39;</span> -WorkloadType <span style="color:#e6db74">&#39;AzureVM&#39;</span> -VaultId $ResourceId
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">foreach</span> ($backupItem <span style="color:#66d9ef">in</span> $backupItems) {
</span></span><span style="display:flex;"><span>                Write-Verbose (<span style="color:#e6db74">&#39;Removing Backup item [{0}] from RSV [{1}]&#39;</span> <span style="color:#f92672">-f</span> $backupItem.Name, $ResourceId) -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                Disable-AzRecoveryServicesBackupProtection -Item $backupItem -VaultId $ResourceId -RemoveRecoveryPoints -Force
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Actual removal</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># --------------</span>
</span></span><span style="display:flex;"><span>            Remove-AzResource -ResourceId $ResourceId -Force -ErrorAction <span style="color:#e6db74">&#39;Stop&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.OperationalInsights/workspaces&#39;</span> {
</span></span><span style="display:flex;"><span>            $resourceGroupName = $ResourceId.Split(<span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>            $resourceName = Split-Path $ResourceId -Leaf
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Force delete workspace (cannot be recovered)</span>
</span></span><span style="display:flex;"><span>            Write-Verbose (<span style="color:#e6db74">&#39;[*] Purging resource [{0}] of type [{1}]&#39;</span> <span style="color:#f92672">-f</span> $resourceName, $Type) -Verbose
</span></span><span style="display:flex;"><span>            Remove-AzOperationalInsightsWorkspace -ResourceGroupName $resourceGroupName -Name $resourceName -Force -ForceDelete
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Microsoft.MachineLearningServices/workspaces&#39;</span> {
</span></span><span style="display:flex;"><span>            $subscriptionId = $ResourceId.Split(<span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>            $resourceGroupName = $ResourceId.Split(<span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>            $resourceName = Split-Path $ResourceId -Leaf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Purge service</span>
</span></span><span style="display:flex;"><span>            $purgePath = <span style="color:#e6db74">&#39;/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.MachineLearningServices/workspaces/{2}?api-version=2023-06-01-preview&amp;forceToPurge=true&#39;</span> <span style="color:#f92672">-f</span> $subscriptionId, $resourceGroupName, $resourceName
</span></span><span style="display:flex;"><span>            $purgeRequestInputObject = @{
</span></span><span style="display:flex;"><span>                Method = <span style="color:#e6db74">&#39;DELETE&#39;</span>
</span></span><span style="display:flex;"><span>                Path   = $purgePath
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            Write-Verbose (<span style="color:#e6db74">&#39;[*] Purging resource [{0}] of type [{1}]&#39;</span> <span style="color:#f92672">-f</span> $resourceName, $Type) -Verbose
</span></span><span style="display:flex;"><span>            $purgeResource = Invoke-AzRestMethod @purgeRequestInputObject
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ($purgeResource.StatusCode <span style="color:#f92672">-notlike</span> <span style="color:#e6db74">&#39;2*&#39;</span>) {
</span></span><span style="display:flex;"><span>                $responseContent = $purgeResource.Content | ConvertFrom-Json
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> (<span style="color:#e6db74">&#39;{0} : {1}&#39;</span> <span style="color:#f92672">-f</span> $responseContent.error.code, $responseContent.error.message)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Wait for workspace to be purged. If it is not purged it has a chance of being soft-deleted via RG deletion (not purged)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># The consecutive deployments will fail because it is not purged.</span>
</span></span><span style="display:flex;"><span>            $retryCount = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            $retryLimit = <span style="color:#ae81ff">240</span>
</span></span><span style="display:flex;"><span>            $retryInterval = <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>                $retryCount++
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> ($retryCount <span style="color:#f92672">-ge</span> $retryLimit) {
</span></span><span style="display:flex;"><span>                    Write-Warning (<span style="color:#e6db74">&#39;    [!] Workspace [{0}] was not purged after {1} seconds. Continuing with resource removal.&#39;</span> <span style="color:#f92672">-f</span> $resourceName, ($retryCount * $retryInterval))
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                Write-Verbose (<span style="color:#e6db74">&#39;    [⏱️] Waiting {0} seconds for workspace to be purged.&#39;</span> <span style="color:#f92672">-f</span> $retryInterval) -Verbose
</span></span><span style="display:flex;"><span>                Start-Sleep -Seconds $retryInterval
</span></span><span style="display:flex;"><span>                $workspace = Get-AzMLWorkspace -Name $resourceName -ResourceGroupName $resourceGroupName -SubscriptionId $subscriptionId -ErrorAction SilentlyContinue
</span></span><span style="display:flex;"><span>                $workspaceExists = $workspace.count <span style="color:#f92672">-gt</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">while</span> ($workspaceExists)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">Default</span> {
</span></span><span style="display:flex;"><span>            Remove-AzResource -ResourceId $ResourceId -Force -ErrorAction <span style="color:#e6db74">&#39;Stop&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="budget-setup">Budget setup</h2>
<p>Now, on to the budget that we have created to trigger the runbook with the PowerShell script.
First we will add a simple budget for 500NOK:
<img src="/img/budget.png" alt="budget setup"></p>
<p>In the Set alerts tab we will set that when the actual cost of the subscription exeeds 100% of the configured budget, it will trigger the action group DeleteResources. This action group is calling the webhook of the runbook. To create the action group click the &ldquo;manage action group&rdquo; link right under alert conditions.
<img src="/img/budget-alert.png" alt="budget alert"></p>
<p>Create a new action group and give it the basic info such as subscription, resource group and a name. Notice that the Action group need to be in the same subscription as the budget is being configured for. Therefore, I have added functionallity to the script that it should skip action groups. In the Actions tab, chose that the desired action is to run an Azure Automation Runbook. In the dropdown menus that appear in the window, find and chose your Automation Account and Runbook. This will create the webhook that it needs to run the script on demand.
<img src="/img/budget-actiongroup.png" alt="budget action group"></p>
<p>That&rsquo;s how simple it is to clean up resources as a budget action. Hopefully this will help Santa to not overspend on the sandbox environments that he has setup for his elves. Again, don&rsquo;t forget to checkout <a href="https://festivetechcalendar.com/">Festive Tech Calendar</a> to see all the awsome content that is being published throughout the whole of December!</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/cost-management/" rel="tag">Cost Management</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/festive-tech-calendar/" rel="tag">Festive Tech Calendar</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/automation/" rel="tag">Automation</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/governance/" rel="tag">Governance</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<p class="authorbox__warning">
		<strong>WARNING:</strong> Authorbox is activated, but [Author] parameters are not specified.
	</p>
</div>



			</div>
			<aside class="sidebar">
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/blogposts/cost-optimizing-azure-monitor/">Cost-Optimizing-Azure-Monitor</a></li>
			<li class="widget__item"><a class="widget__link" href="/blogposts/log-analytics-agent-deprecation/">Log Analytics Agent deprecation - Prepare for the end</a></li>
			<li class="widget__item"><a class="widget__link" href="/blogposts/santas-magic-cost-management-automation/">Santa´s Magic Cost Management Automation</a></li>
			<li class="widget__item"><a class="widget__link" href="/blogposts/azurebacktoschool23/">Automate common cost optimizations</a></li>
			<li class="widget__item"><a class="widget__link" href="/blogposts/cost-optmization-in-the-wild/">Cost Optmization in the Wild</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/automation/" title="Automation">Automation</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-ad-connect/" title="Azure AD Connect">Azure AD Connect</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-automation/" title="Azure Automation">Azure Automation</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-compute/" title="Azure Compute">Azure Compute</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-firewall/" title="Azure Firewall">Azure Firewall</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-operations/" title="Azure Operations">Azure Operations</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-paas/" title="Azure PaaS">Azure PaaS</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-policy/" title="Azure Policy">Azure Policy</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-resource-graph/" title="Azure Resource Graph">Azure Resource Graph</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-spring-clean/" title="Azure Spring Clean">Azure Spring Clean</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-sql/" title="Azure SQL">Azure SQL</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure-vm/" title="Azure VM">Azure VM</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/bicep/" title="Bicep">Bicep</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/compute/" title="Compute">Compute</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cost-management/" title="Cost Management">Cost Management</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cost-optimization/" title="Cost Optimization">Cost Optimization</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/festive-tech-calendar/" title="Festive Tech Calendar">Festive Tech Calendar</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/governance/" title="Governance">Governance</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/iac/" title="IaC">IaC</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/kql/" title="KQL">KQL</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/operations/" title="Operations">Operations</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/powershell/" title="PowerShell">PowerShell</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/public-speaking/" title="Public Speaking">Public Speaking</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/security/" title="Security">Security</a>
	</div>
</div>
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Twitter" rel="noopener noreferrer" href="https://twitter.com/@ErlendRushfeldt" target="_blank">
				<svg class="widget-social__link-icon icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5 0-78.8 35.3-78.8 78.8 0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6 0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1 0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4 0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9 0 224.1-120 224.1-224.1 0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg>
				<span>Twitter</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="LinkedIn" rel="noopener noreferrer" href="https://linkedin.com/in/erlend-rushfeldt-b0a92a159" target="_blank">
				<svg class="widget-social__link-icon icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0,40v272c0,21.9,18.1,40,40,40h272c21.9,0,40-18.1,40-40V40c0-21.9-18.1-40-40-40H40C18.1,0,0,18.1,0,40z M312,32 c4.6,0,8,3.4,8,8v272c0,4.6-3.4,8-8,8H40c-4.6,0-8-3.4-8-8V40c0-4.6,3.4-8,8-8H312z M59.5,87c0,15.2,12.3,27.5,27.5,27.5 c15.2,0,27.5-12.3,27.5-27.5c0-15.2-12.3-27.5-27.5-27.5C71.8,59.5,59.5,71.8,59.5,87z M187,157h-1v-21h-45v152h47v-75 c0-19.8,3.9-39,28.5-39c24.2,0,24.5,22.4,24.5,40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5,132.5,193.3,145.1,187,157z M64,288h47.5 V136H64V288z"/></svg>
				<span>LinkedIn</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/Fr3xzy" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>

		
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2025 Erlend Rushfeldt - Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>